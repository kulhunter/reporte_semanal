<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de KPIs Semanales</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        .progress-bar-bg {
            background-color: #e5e7eb;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            border-radius: 0.5rem;
            transition: width 0.5s ease-in-out;
            background: linear-gradient(to right, #34d399, #10b981);
        }
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 100; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgb(0,0,0); /* Fallback color */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 0.75rem;
        }
        /* Critical Error Modal */
        .error-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }
        .error-modal-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 0.75rem;
            text-align: center;
            max-width: 90%;
            width: 600px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Dashboard de KPIs</h1>
            <p class="text-gray-500 mt-1">Seguimiento de resultados de Julio a Diciembre.</p>
            <p class="text-xs text-gray-400 mt-2">ID de Usuario: <span id="userId">Cargando...</span></p>
        </header>

        <!-- Input Form Card -->
        <div class="card mb-8">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Registrar Datos Semanales</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label for="week-select" class="block text-sm font-medium text-gray-700 mb-1">Seleccionar Semana</label>
                    <select id="week-select" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <!-- Options will be generated by JS -->
                    </select>
                </div>
                <div class="md:col-span-2 self-end">
                     <button id="load-week-data" class="w-full md:w-auto bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition duration-300">Cargar Datos de la Semana</button>
                </div>
            </div>
        </div>

        <!-- KPI Display -->
        <div id="kpi-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- KPI cards will be generated by JS -->
        </div>
    </div>

    <!-- Data Entry Modal -->
    <div id="data-entry-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-800" id="modal-title">Ingresar Datos</h3>
                <button id="close-modal" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <form id="kpi-form">
                <div id="modal-form-inputs" class="space-y-4">
                    <!-- Form inputs are generated here -->
                </div>
                <div class="mt-6 flex justify-end">
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Critical Error Modal -->
    <div id="critical-error-modal" class="error-modal-overlay" style="display: none;">
        <div class="error-modal-content">
            <h2 class="text-2xl font-bold text-red-600 mb-4">¡Acción Requerida!</h2>
            <div id="error-message-content" class="text-gray-700"></div>
        </div>
    </div>
    
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURACIÓN ---
        const firebaseConfig = {
          apiKey: "AIzaSyABENFsser5DBLIm1pIM0dBQUVq5Jc5RMc",
          authDomain: "reporte-2win.firebaseapp.com",
          projectId: "reporte-2win",
          storageBucket: "reporte-2win.appspot.com",
          messagingSenderId: "952290286295",
          appId: "1:952290286295:web:d1d28760d5b4c6cd5dee92",
          measurementId: "G-X2L0TP9CC6"
        };
        
        const appId = "reporte-2win-dashboard";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let userId = null;
        let weeklyData = {};
        let chartInstances = {}; // To keep track of charts

        const kpis = [
            { id: 'leads', name: 'Leads', weeklyGoal: 2.5, totalGoal: 60, format: 'float' },
            { id: 'visitas', name: 'Visitas Mensuales', weeklyGoal: 250, totalGoal: 6000, format: 'integer' },
            { id: 'impresiones', name: 'Impresiones', weeklyGoal: 333, totalGoal: 8000, format: 'integer' },
            { id: 'seguidores', name: 'Seguidores LinkedIn', weeklyGoal: 10, totalGoal: 240, format: 'integer' },
            { id: 'suscriptores', name: 'Suscriptores LinkedIn', weeklyGoal: 20.8, totalGoal: 1000, format: 'float' },
            { id: 'comentarios', name: 'Comentarios LinkedIn', weeklyGoal: 18.4, totalGoal: 50, format: 'float' }
        ];

        // --- AUTENTICACIÓN Y CARGA DE DATOS ---
        onAuthStateChanged(auth, user => {
            if (user) {
                document.getElementById('critical-error-modal').style.display = 'none';
                userId = user.uid;
                document.getElementById('userId').textContent = userId;
                loadInitialData();
            } else {
                signInAnonymously(auth).catch(error => {
                    console.error("Anonymous sign-in failed:", error);
                    document.getElementById('userId').textContent = "Error de conexión";
                    if (error.code === 'auth/configuration-not-found') {
                        showCriticalError(
                            `<p class="mb-4">La aplicación no puede conectar a la base de datos porque el <strong>inicio de sesión anónimo no está habilitado</strong> en tu proyecto de Firebase.</p>
                             <p class="mb-2"><strong>Solución:</strong></p>
                             <ol class="list-decimal list-inside text-left mx-auto max-w-md">
                                 <li class="mb-2">Ve a tu <a href="https://console.firebase.google.com/project/${firebaseConfig.projectId}/authentication/providers" target="_blank" class="text-blue-600 hover:underline font-semibold">Consola de Firebase</a>.</li>
                                 <li class="mb-2">En la sección <strong>Authentication</strong>, ve a la pestaña <strong>Sign-in method</strong>.</li>
                                 <li class="mb-2">Busca <strong>Anónimo</strong> en la lista, haz clic, activa el interruptor y guarda.</li>
                                 <li class="mb-2">Recarga esta página.</li>
                             </ol>`
                        );
                    } else {
                         showCriticalError("Ocurrió un error de autenticación inesperado. Revisa la consola para más detalles.");
                    }
                });
            }
        });

        function loadInitialData() {
            if (!userId) return;
            const collectionPath = `kpi_dashboard/${appId}/users/${userId}/weekly_kpis`;
            const q = query(collection(db, collectionPath));
            onSnapshot(q, (querySnapshot) => {
                weeklyData = {};
                querySnapshot.forEach((doc) => {
                    weeklyData[doc.id] = doc.data();
                });
                renderDashboard();
            }, (error) => {
                console.error("Error fetching data with onSnapshot:", error);
            });
        }

        // --- LÓGICA DE LA INTERFAZ ---
        function showCriticalError(htmlMessage) {
            const modal = document.getElementById('critical-error-modal');
            const content = document.getElementById('error-message-content');
            content.innerHTML = htmlMessage;
            modal.style.display = 'flex';
        }

        function getDateRangeOfWeek(weekNo) {
            const baseDate = new Date('2024-07-01T00:00:00');
            const weekOffset = weekNo - 27;
            const startDate = new Date(baseDate);
            startDate.setDate(baseDate.getDate() + weekOffset * 7);
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);
            const format = (d) => `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}`;
            return `(${format(startDate)} - ${format(endDate)})`;
        }

        function populateWeekSelector() {
            const select = document.getElementById('week-select');
            select.innerHTML = '';
            for (let i = 27; i <= 52; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Semana ${i} ${getDateRangeOfWeek(i)}`;
                select.appendChild(option);
            }
        }

        function renderDashboard() {
            const grid = document.getElementById('kpi-grid');
            grid.innerHTML = '';

            // Destroy old charts before re-rendering
            Object.values(chartInstances).forEach(chart => chart.destroy());
            chartInstances = {};
            
            const totalAccumulated = kpis.map(kpi => Object.values(weeklyData).reduce((sum, week) => sum + (Number(week[kpi.id]) || 0), 0));
            
            kpis.forEach((kpi, index) => {
                const accumulated = totalAccumulated[index];
                const totalProgress = kpi.totalGoal > 0 ? (accumulated / kpi.totalGoal) * 100 : 0;
                
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div>
                        <h3 class="font-semibold text-lg text-gray-800">${kpi.name}</h3>
                        <p class="text-gray-500 text-sm mb-4">Meta Semanal: ${kpi.weeklyGoal.toLocaleString('es-ES')}</p>
                        <div class="text-center my-4">
                            <p class="text-3xl font-bold text-indigo-600">${accumulated.toLocaleString('es-ES')}</p>
                            <p class="text-gray-500">de ${kpi.totalGoal.toLocaleString('es-ES')} (Total)</p>
                        </div>
                        <div class="w-full progress-bar-bg h-4">
                            <div class="progress-bar h-4" style="width: ${Math.min(totalProgress, 100)}%;"></div>
                        </div>
                        <p class="text-right text-sm mt-2 font-medium">${totalProgress.toFixed(1)}%</p>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-200 flex-grow">
                        <div class="h-24 relative">
                            <canvas id="chart-${kpi.id}"></canvas>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });

            // Create charts after cards are in the DOM
            kpis.forEach(kpi => {
                const ctx = document.getElementById(`chart-${kpi.id}`).getContext('2d');
                
                const labels = [];
                for (let i = 27; i <= 52; i++) {
                    labels.push(`S${i}`);
                }

                const chartData = labels.map(label => {
                    const weekNum = label.substring(1);
                    const weekKey = `week_${weekNum}`;
                    return weeklyData[weekKey]?.[kpi.id] || 0;
                });

                chartInstances[kpi.id] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: kpi.name,
                            data: chartData,
                            borderColor: 'rgba(79, 70, 229, 0.8)',
                            backgroundColor: 'rgba(199, 210, 254, 0.3)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 1,
                            pointBackgroundColor: 'rgba(79, 70, 229, 0.8)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { display: false },
                                grid: { display: false },
                                border: { display: false }
                            },
                            x: {
                                ticks: { display: false },
                                grid: { display: false },
                                border: { display: false }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    title: function(context) {
                                        const weekNum = context[0].label.substring(1);
                                        return `Semana ${weekNum}`;
                                    }
                                }
                            }
                        }
                    }
                });
            });
        }
        
        // --- MANEJO DEL MODAL ---
        const modal = document.getElementById('data-entry-modal');
        const closeModalBtn = document.getElementById('close-modal');
        const loadWeekDataBtn = document.getElementById('load-week-data');
        const kpiForm = document.getElementById('kpi-form');

        closeModalBtn.onclick = () => { modal.style.display = "none"; };
        window.onclick = (event) => { if (event.target == modal) modal.style.display = "none"; };

        loadWeekDataBtn.addEventListener('click', () => {
            if (!userId) {
                showCriticalError("La conexión con la base de datos falló. Por favor, sigue las instrucciones en pantalla para solucionar el problema.");
                return;
            }
            const weekSelect = document.getElementById('week-select');
            const selectedWeek = weekSelect.value;
            const selectedWeekText = weekSelect.options[weekSelect.selectedIndex].text;
            document.getElementById('modal-title').textContent = `Ingresar Datos - ${selectedWeekText}`;
            const formInputs = document.getElementById('modal-form-inputs');
            formInputs.innerHTML = '';
            const currentWeekData = weeklyData[`week_${selectedWeek}`] || {};
            kpis.forEach(kpi => {
                const value = currentWeekData[kpi.id] || '';
                const step = kpi.format === 'float' ? '0.1' : '1';
                formInputs.insertAdjacentHTML('beforeend', `<div><label for="kpi-${kpi.id}" class="block text-sm font-medium text-gray-700">${kpi.name}</label><input type="number" id="kpi-${kpi.id}" name="${kpi.id}" value="${value}" step="${step}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="0"></div>`);
            });
            modal.style.display = "block";
        });

        kpiForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!userId) { alert("No se pueden guardar los datos. Hay un problema de conexión con la base de datos."); return; }
            const weekSelect = document.getElementById('week-select');
            const selectedWeek = weekSelect.value;
            const docId = `week_${selectedWeek}`;
            const collectionPath = `kpi_dashboard/${appId}/users/${userId}/weekly_kpis`;
            const formData = new FormData(kpiForm);
            const dataToSave = { week: parseInt(selectedWeek) };
            for(let [key, value] of formData.entries()) dataToSave[key] = parseFloat(value) || 0;
            try {
                await setDoc(doc(db, collectionPath, docId), dataToSave);
                modal.style.display = "none";
            } catch (error) {
                console.error("Error saving document: ", error);
                alert("Hubo un error al guardar los datos.");
            }
        });

        // --- INICIALIZACIÓN ---
        window.onload = () => {
            populateWeekSelector();
        };

    </script>
</body>
</html>
